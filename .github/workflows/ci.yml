name: ğŸš€ Abacus Quality Gate

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']
  workflow_dispatch: # Permet le lancement manuel

# SÃ©curitÃ© : Limite les permissions du token au minimum nÃ©cessaire
permissions:
  contents: read

jobs:
  # ------------------------------------------------------------------
  # JOB FRONTEND
  # ------------------------------------------------------------------
  frontend:
    name: ğŸ¨ Frontend (React/Vite)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        # 'npm ci' est plus strict et rapide que 'npm install' pour la CI
        run: npm ci

      - name: ğŸ’… Linting (ESLint)
        # VÃ©rifie le style et les erreurs potentielles
        run: npm run lint

      - name: ğŸ” Type Checking (TypeScript)
        # VÃ©rifie la cohÃ©rence des types sans Ã©mettre de fichiers
        run: npx tsc --noEmit

      - name: ğŸ§ª Unit Tests (Vitest)
        # Lance les tests en mode "run" (pas de watch)
        run: npm run test -- --run

      - name: ğŸ—ï¸ Production Build
        # VÃ©rifie que le build de production passe sans erreur
        run: npm run build

  # ------------------------------------------------------------------
  # JOB BACKEND
  # ------------------------------------------------------------------
  backend:
    name: ğŸ Backend (FastAPI)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: ./backend

    # Variables d'environnement pour le contexte de test
    env:
      DATABASE_URL: 'sqlite:///:memory:'
      SECRET_KEY: 'ci-secret-key-do-not-use-in-production'
      ALGORITHM: 'HS256'
      ACCESS_TOKEN_EXPIRE_MINUTES: 30

    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ§¹ Code Analysis (Ruff)
        # VÃ©rifie les erreurs de code et les bonnes pratiques
        run: ruff check .

      - name: ğŸ¨ Format Check (Ruff)
        # VÃ©rifie que le code respecte le formatage standard
        run: ruff format --check .

      - name: ğŸ§ª Unit Tests (Pytest)
        # Lance les tests (utilise conftest.py pour la DB en mÃ©moire)
        run: pytest
